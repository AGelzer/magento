stages:
- install_dependencies
- test

composer_install:php56:
  image: grintegrations/magento2_php56_gitlab_runner_image
  stage: install_dependencies
  script:
  - composer config -a -g http-basic.repo.magento.com $COMPOSER_REPO_MAGENTO_USERNAME $COMPOSER_REPO_MAGENTO_PASSWORD
  - composer install --prefer-dist --no-progress --optimize-autoloader
  except:
  - develop

test:app-php56:
  image: grintegrations/magento2_php56_gitlab_runner_image
  stage: test
  tags:
  - kubernetes-ci
  script:
  - composer config -a -g http-basic.repo.magento.com 0cda6f69951a956023e310d336c6c668 f75f66caf3a80070c61af646b5addabc
  - composer install --prefer-dist --no-progress --optimize-autoloader
  - ./vendor/bin/phpunit --testsuite unit --configuration ./Test/phpunit.xml --colors=never
  except:
  - develop
  dependencies:
  - composer_install:php56

composer_install:php71:
  image: grintegrations/magento2_php71_gitlab_runner_image
  stage: install_dependencies
  script:
  - composer config -a -g http-basic.repo.magento.com $COMPOSER_REPO_MAGENTO_USERNAME $COMPOSER_REPO_MAGENTO_PASSWORD
  - composer install --prefer-dist --no-progress --optimize-autoloader
  except:
  - develop

test:app-php71:
  image: grintegrations/magento2_php71_gitlab_runner_image
  stage: test
  tags:
  - kubernetes-ci
  script:
  - composer config -a -g http-basic.repo.magento.com 0cda6f69951a956023e310d336c6c668 f75f66caf3a80070c61af646b5addabc
  - composer install --prefer-dist --no-progress --optimize-autoloader
  - ./vendor/bin/phpunit --testsuite unit --configuration ./Test/phpunit.xml --colors=never
  except:
  - develop
  dependencies:
  - composer_install:php71
